<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ThingSpeak IoT Monitor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:0; padding:1rem; background:#f0f4f8;}
    .card {background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.1); max-width:700px; margin:auto;}
    h1 {font-size:1.4rem; text-align:center; margin-bottom:1rem;}
    .result {font-size:1.1rem; text-align:center; margin:.5rem 0;}
    canvas {max-width:100%;}
  </style>
</head>
<body>
  <div class="card">
    <h1>ThingSpeak IoT Data Summary (Last 15 Minutes)</h1>
    <div class="result" id="avgRoll">Average Roll: loading…</div>
    <div class="result" id="avgPitch">Average Pitch: loading…</div>
    <div class="result" id="ratio">Ratio (Roll + Pitch &gt; 20 : &lt; 20): loading…</div>
    <canvas id="iotChart" height="200"></canvas>
  </div>

  <script>
    const channelID       = 2994825;
    const apiKey          = 'H6JGG2ORJPJFQCEF';   // read-only key
    const field1          = 'field1';             // Roll
    const field2          = 'field2';             // Pitch
    const resultsLimit    = 800;                  // safety cap
    const refreshInterval = 30000;                // 30 s

    const ctx = document.getElementById('iotChart').getContext('2d');
    const iotChart = new Chart(ctx, {
      type:'line',
      data:{labels:[], datasets:[
        {label:'Roll',  data:[], borderColor:'#007bff', fill:false, tension:.2},
        {label:'Pitch', data:[], borderColor:'#28a745', fill:false, tension:.2}
      ]},
      options:{responsive:true, scales:{
        x:{type:'time', time:{unit:'minute', tooltipFormat:'HH:mm:ss'}},
        y:{beginAtZero:true}
      }}
    });

    function fetchAndUpdate() {
      const now = Date.now();
      const cutoff = now - 15 * 60 * 1000;   // 15 min ago

      const url =
        `https://api.thingspeak.com/channels/${channelID}/feeds.json` +
        `?api_key=${apiKey}&results=${resultsLimit}`;

      fetch(url)
        .then(r => r.json())
        .then(({feeds}) => {
          const labels=[], rollData=[], pitchData=[];
          let sumRoll=0, sumPitch=0, n=0, above20=0, below20=0;

          feeds.forEach(f => {
            const t = new Date(f.created_at).getTime();
            if (t < cutoff) return;
            const roll  = parseFloat(f[field1]);
            const pitch = parseFloat(f[field2]);
            if (isNaN(roll) || isNaN(pitch)) return;

            labels.push(new Date(t));
            rollData.push(roll);
            pitchData.push(pitch);
            sumRoll += roll; sumPitch += pitch; n++;

            (roll+pitch > 20 ? above20 : below20)++;
          });

          document.getElementById('avgRoll').textContent  = `Average Roll: ${n ? (sumRoll/n).toFixed(2) : 'N/A'}`;
          document.getElementById('avgPitch').textContent = `Average Pitch: ${n ? (sumPitch/n).toFixed(2) : 'N/A'}`;
          document.getElementById('ratio').textContent    =
            `Ratio (Roll + Pitch > 20 : < 20): ${n ? `${above20} : ${below20}` : 'N/A'}`;

          iotChart.data.labels = labels;
          iotChart.data.datasets[0].data = rollData;
          iotChart.data.datasets[1].data = pitchData;
          iotChart.update();
        })
        .catch(err => {
          console.error(err);
          ['avgRoll','avgPitch','ratio'].forEach(id =>
            document.getElementById(id).textContent = 'Error loading data');
        });
    }

    fetchAndUpdate();
    setInterval(fetchAndUpdate, refreshInterval);
  </script>
</body>
</html>
